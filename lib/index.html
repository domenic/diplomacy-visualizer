<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<title>Diplomacy Visualizer</title>
<link rel="stylesheet" href="styles.css">

<script src="https://d3js.org/d3.v5.js" defer></script>
<script type="module">
main();
import makeGraph from "./graph.mjs";

const WIDTH = 800;
const HEIGHT = 800;

const NODE_WIDTH = 100;
const NODE_HEIGHT = 20;

async function main() {
  const [boardData, countryData] = await Promise.all([
    fetch("./board-data.json").then(res => res.json()),
    fetch("./country-data.json").then(res => res.json())
  ]);

  const { nodes, edges } = makeGraph(boardData, countryData);

  const simulation = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(edges).id(n => n.name))
      .force("charge", d3.forceManyBody())
      .force("center", d3.forceCenter(WIDTH / 2, HEIGHT / 2))
      .force("collide", d3.forceCollide(n => width(n) / 2 + 5))
      .force("boundaries", () => {
        for (const node of nodes) {
          node.x = Math.max(width(node) / 2, Math.min(node.x, WIDTH - width(node) / 2));
          node.y = Math.max(NODE_HEIGHT / 2, Math.min(node.y, HEIGHT - NODE_HEIGHT / 2));
        }
      });

  const svg = d3.select("body").append("svg").attr("viewBox", [0, 0, WIDTH, HEIGHT]);

  const edgeNodes = svg.append("g")
    .attr("id", "edges")
    .selectAll("line")
    .data(edges)
    .join("line")
    .attr("class", n => [...n.types].join(" "));

  const nodeNodes = svg.append("g")
    .attr("id", "regions")
    .selectAll("g")
    .data(nodes)
    .join("g")
    .attr("class", n => n.allegiance)

  nodeNodes.append("rect")
    .attr("width", width)
    .attr("height", NODE_HEIGHT);

  nodeNodes.append("text")
    .text(n => n.name)
    .attr("x", n => width(n) / 2)
    .attr("y", NODE_HEIGHT / 2);

  simulation.on("tick", () => {
    edgeNodes
      .attr("x1", e => e.source.x)
      .attr("y1", e => e.source.y)
      .attr("x2", e => e.target.x)
      .attr("y2", e => e.target.y);

    nodeNodes
      .attr("transform", n => `translate(${n.x - width(n) / 2},${n.y - NODE_HEIGHT / 2})`);
  });
}

function width(n) {
  return 10 + n.name.length * 7;
}
</script>
